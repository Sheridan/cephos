#!/bin/bash

clr_reset="\e[0m"
clr_info="\e[1;32m" # INFO
clr_warn="\e[1;33m" # WARN
clr_err="\e[1;31m"  # ERROR
clr_verb="\e[1;36m"
verbose=0

function log_message()
{
  local log_level="$1"
  local log_color="$2"
  local log_text="$3"
  echo -e "[${log_color}${log_level}${clr_reset}] ${log_text}"
}

function log_verbose()
{
  local message="$1"
  if (( verbose ))
  then
    log_message "V" "$clr_verb" "$message"
  fi
}

function log_info()
{
  local message="$1"
  log_message "I" "$clr_info" "$message"
}

function log_wrn()
{
  local message="$1"
  log_message "W" "$clr_warn" "$message"
}

function log_err()
{
  local message="$1"
  log_message "E" "$clr_err" "$message"
}

function wrong_opt()
{
  local message="$1"
  log_err "${message}"
  help
  exit 1
}

function set_config_var()
{
  local config_file="$1"
  local var_name="$2"
  local new_value="$3"

  if [[ ! -f "$config_file" ]]
  then
    sudo touch "$config_file"
  fi

  if grep -qE "^${var_name}=" "$config_file"
  then
    sudo sed -i "s|^${var_name}=.*|${var_name}=${new_value}|" "$config_file"
  else
    echo "${var_name}=${new_value}" | sudo tee -a "$config_file" > /dev/null
  fi
}

function read_config_var()
{
  local env_file="${1}"
  local var_name="${2}"
  local default_value="${3}"
  local line_value

  if [[ ! -f "$env_file" ]]
  then
    echo "$default_value"
    return 0
  fi

  line_value=$(grep -E "^${var_name}=" "$env_file" | tail -n 1 | cut -d '=' -f2-)
  if [[ -n "$line_value" ]]
  then
      echo "$line_value"
  else
      echo "$default_value"
  fi
}

function set_environment()
{
  local var_name="$1"
  local new_value="$2"
  set_config_var "/etc/default/ceph" "${var_name}" "${new_value}"
}

function get_environment()
{
  local var_name="$1"
  local default_value="$2"
  read_config_var "/etc/default/ceph" "${var_name}" "${default_value}"
}

function check_user()
{
  local target_user="$1"
  if [[ "$(id -un)" != "${target_user}" ]]
  then
    log_err "Must be run as user ${target_user}"
    exit 1
  fi
}

function check_hostname()
{
  if [[ "$0" == "/usr/local/bin/cephos-init-host" ]]
  then
    return 0
  fi
  if [[ "$(hostname -s)" == "debian" ]]
  then
    log_err "Change hostname please"
    exit 1
  fi
}

function help()
{
  echo "$help_text"
  exit 0
}

function set_file_rights()
{
  log_verbose "Выставление прав"
  sudo chown -R ceph:ceph ${ceph_conf_dir}
  sudo chown -R ceph:ceph ${ceph_data_dir}
  sudo chmod 640 ${ceph_main_conf}
  sudo chmod 600 ${ceph_conf_dir}/*.keyring
}

check_hostname
ceph_conf_dir="/etc/ceph"
ceph_data_dir="/var/lib/ceph"
ceph_main_conf="${ceph_conf_dir}/ceph.conf"
ceph_fsid=$(get_environment "FSID" "none")
mon_id="$(hostname -s)"
mon_data_dir="${ceph_data_dir}/mon.${mon_id}"
osd_data_dir="${ceph_data_dir}/osd"

log_info "Main conf file: ${ceph_main_conf}"
log_info "Ceph fsid: ${ceph_fsid}"
log_info "Ceph mon id: ${mon_id}"
