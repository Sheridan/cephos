#!/usr/bin/env bash

[[ -n "${LIB_CEPHOS_IN:-}" ]] && return 0
LIB_CEPHOS_IN=1

. /usr/local/lib/cephos/base.sh.lib
. /usr/local/lib/cephos/config.sh.lib
. /usr/local/lib/cephos/ceph.sh.lib


function check_hostname()
{
  if is_local_host "${build_hostname}"
  then
    log_cry "Change hostname please (use cephos-init-host)"
  fi
}

function is_local_host()
{
  local check_hostname="$1"
  [[ "$(hostname -s)" == "${check_hostname}" ]]
}

function set_recursive_permissions()
{
  local target_directory="$1"

  log_verbose "Setting permissions for ${target_directory}"
  sudo chown -R ceph:ceph "${target_directory}"
  sudo find "${target_directory}" -type d -exec chmod 750 {} \;
  sudo find "${target_directory}" -type f -exec chmod 640 {} \;
}

function set_fs_permissions()
{
  log_verbose "Setting permissions"
  set_recursive_permissions "${ceph_conf_dir}"
  set_recursive_permissions "${ceph_data_dir}"
}

function create_directories()
{
  log_verbose "Creating directories"
  sudo mkdir -p ${ceph_data_dir}/bootstrap-mon \
                ${ceph_data_dir}/bootstrap-mds \
                ${ceph_data_dir}/bootstrap-mgr \
                ${ceph_data_dir}/bootstrap-osd \
                ${ceph_data_dir}/bootstrap-rgw
  set_fs_permissions
}

function update_hostname()
{
  local node_hostname
  node_hostname=$(get_node_environment "hostname" "${build_hostname}")
  local _hostname="${node_hostname%%.*}"
  local _domain="${node_hostname#*.}"

  if [[ "$(dnsdomainname)" == "${_domain}" ]]
  then
    log_info "Domain name '${_domain}' already set"
  else
    log_info "Updating domain name to '${_domain}'"
    sudo domainname "${_domain}"
  fi

  if is_local_host "${_hostname}"
  then
    log_info "Hostname '${_hostname}' already set"
  else
    log_info "Updating hostname to '${_hostname}'"
    sudo hostnamectl hostname "${_hostname}"
  fi
}

function update_timezone()
{
  local node_timezone
  node_timezone=$(get_node_environment "timezone" "Etc/UTC")
  if [[ "$(readlink -f /etc/localtime)" == "/usr/share/zoneinfo/${node_timezone}" ]]
  then
    log_info "Timezone '${node_timezone}' already set"
  else
    log_info "Updating timezone to '${node_timezone}'..."
    sudo timedatectl set-timezone "${node_timezone}"
    sudo timedatectl set-ntp yes
  fi
}

function get_mon_id() { hostname -s; }
function get_mgr_id() { hostname -s; }
