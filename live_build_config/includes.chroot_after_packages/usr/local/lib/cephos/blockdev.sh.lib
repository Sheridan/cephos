#!/usr/bin/env bash

function clean_lvm_labels()
{
  local block_device="$1"
  log_info "Cleaning LVM labels in ${block_device}"
  if sudo wipefs "${block_device}" | grep -q 'LVM2_member'
  then
    log_info "Cleaning LVM label from ${block_device}..."
    sudo vgchange -an || true
    sudo pvremove -ff -y "${block_device}" || true
    sudo sgdisk --zap-all "${block_device}" || true
    sudo wipefs -f -a "${block_device}"
    log_info "${block_device} cleaned."
  fi
}

function purge_device()
{
  local block_device="$1"

  clean_lvm_labels "${block_device}"

  log_info "Purging device ${block_device}"

  sudo dd if=/dev/zero of="${block_device}" bs=1M count=100 conv=fsync

  local disk_size
  disk_size=$(sudo blockdev --getsz "${block_device}")
  local sectors_100M=$((100*1024*1024/512))    # 204800
  local seek_lvm=$((disk_size - sectors_100M))
  sudo dd if=/dev/zero of="${block_device}" bs=512 seek=${seek_lvm} count=${sectors_100M} conv=fsync

  local size_mb=$((disk_size * 512 / 1024 / 1024))
  local seek_gpt=$((size_mb - 10))
  sudo dd if=/dev/zero of="${block_device}" bs=1M seek=${seek_gpt} count=10 conv=fsync

  sudo partprobe ${block_device} || sudo blockdev --rereadpt "${block_device}" || true
  sleep 1
}

function print_device_info()
{
  local device="$1"
  log_info "Device Info: ${device}"
  lsblk -o NAME,SIZE,PARTLABEL,LABEL,FSTYPE,MODEL,VENDOR,SERIAL,UUID,MOUNTPOINT "${device}"
  log_delimiter
}
