#!/usr/bin/env bash

. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
Usage: $0 -n <fqdn>
Example: $0 -n ceph-first.domain.local
EOF

set -euo pipefail

# --- options parse ---
fqdn=""
while getopts ":n:hv" opt
do
  case ${opt} in
    n) fqdn="${OPTARG}" ;;
    h) help; exit 0 ;;
    v) verbose=1 ;;
   \?) wrong_opt "Ошибка: неизвестная опция -${OPTARG}" ;;
    :) wrong_opt "Ошибка: опция -${OPTARG} требует аргумент" ;;
  esac
done

if [[ -z "$fqdn" ]]
then
  wrong_opt "Не указаны опции"
fi

if [[ "$fqdn" != *.* ]]
then
  log_cry "Ошибка: строка '$fqdn' не является FQDN (нет доменной части)"
fi
# --- options parse ---
check_user "cephos"

_hostname="${fqdn%%.*}"
_domain="${fqdn#*.}"

function restart_shell()
{
  local current_shell
  current_shell=$(basename "$SHELL")

  log_verbose "Переинициализирую оболочку ${current_shell}"
  case "${current_shell}" in
    bash) exec bash ;;
    zsh)  exec zsh ;;
    *)    log_cry "Неизвестная оболочка: $current_shell. Поддерживаются только bash и zsh. Relogin for update hostname" ;;
  esac
}

if [[ "$(hostname -s)" == "debian" ]]
then
  log_info "Setting hostname to ${_hostname} and domain to ${_domain}"
  sudo sed -i "s/\bdebian\b/ ${_hostname} /g" "/etc/hosts"
  sudo domainname "${_domain}"
  sudo hostnamectl hostname "${_hostname}"
  restart_shell
fi
