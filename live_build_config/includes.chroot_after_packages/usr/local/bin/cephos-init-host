#!/usr/bin/env bash

. /usr/local/lib/cephos/network.sh.lib
. /usr/local/lib/cephos/systemd.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
CephOS host initialization script

Options:
  -n <fqdn>             (Required) Specify the Fully Qualified Domain Name (FQDN) for the host
  -P <public_network>   (Required) Specify the public network in CIDR notation (e.g., 10.10.0.0/24)
  -C <cluster_network>  (Optional) Specify the cluster network in CIDR notation (e.g., 10.20.0.0/24)
                                  Default: public network
  -p <public_ip>        (Required) Specify the public IP address for this host
  -c <cluster_ip>       (Optional) Specify the cluster IP address for this host
                                  Default: public IP
  -z <timezone>         (Optional) Specify the host timezone
                                  Default: Etc/UTC
  -h                    Display this help message
  -v                    Enable verbose output

Examples:
# Initialize host with FQDN
$0 -n ceph-first.domain.local -P 10.10.0.0/24 -C 10.20.0.0/24 -p 10.10.0.100 -c 10.20.0.100
EOF
set -euo pipefail
# --- functions ---
function restart_shell()
{
  local current_shell executable_name
  current_shell=$(ps -p $$ -o comm=)
  executable_name=$(basename "${current_shell}")

  log_verbose "Reinitializing current shell: ${executable_name}"

  case "${executable_name}" in
    bash) source ~/.bashrc ;;
     zsh) source ~/.zshrc  ;;
       *) log_cry "Unknown shell: ${executable_name}" ;;
  esac
}

function set_hostname()
{
  log_info "Setting hostname to ${fqdn}..."
  set_node_environment "hostname" "${fqdn}"
}

function set_timezone()
{
  log_info "Setting timezone to ${timezone}..."
  set_node_environment "timezone" "${timezone}"
}

function enable_init_service()
{
  manage_systemd_service_state "enable" "cephos-host-init"
}
# --- functions ---
# --- options parse ---
fqdn=""
public_network=""
cluster_network=""
public_ip=""
cluster_ip=""
timezone=""
while getopts ":z:P:C:p:c:n:hv" opt
do
  case ${opt} in
    n) fqdn="${OPTARG}"            ;;
    P) public_network="${OPTARG}"  ;;
    C) cluster_network="${OPTARG}" ;;
    p) public_ip="${OPTARG}"       ;;
    c) cluster_ip="${OPTARG}"      ;;
    z) timezone="${OPTARG}"        ;;
    h) usage     ;;
    v) verbose=1 ;;
   \?) wrong_opt "Unknown option -${OPTARG}"              ;;
    :) wrong_opt "Option -${OPTARG} requires an argument" ;;
  esac
done

if [[ -z "${fqdn}" ]]
then
  wrong_opt "Hostname (-n) is not set"
fi

if [[ "${fqdn}" != *.* ]]
then
  log_cry "String '${fqdn}' is not a FQDN (missing domain part)"
fi

if [[ -z "${public_network}" ]]
then
  wrong_opt "Public network (-P) not specified"
fi

if [[ -z "${cluster_network}"  ]]
then
  cluster_network="${public_network}"
fi

if [[ -z "${public_ip}"  ]]
then
  wrong_opt "Public IP (-p) not specified"
fi

if [[ -z "${cluster_ip}"  ]]
then
  cluster_ip="${public_ip}"
fi

if [[ -n "${timezone}" ]]
then
  if [[ ! -f "/usr/share/zoneinfo/${timezone}" ]]
  then
    log_cry "Timezone '${timezone}' not found under /usr/share/zoneinfo"
  fi
else
  wrong_opt "Timezone (-z) not specified"
fi
# --- options parse ---
# --- main ---
check_user "${build_user}"

log_info "Initializing host ${fqdn} for Ceph with public [${public_ip} : ${public_network}] and cluster [${cluster_ip} : ${cluster_network}] networks"

set_timezone

set_cluster_environment "public_network" "${public_network}"
set_cluster_environment "cluster_network" "${cluster_network}"
set_node_environment "public_ip" "${public_ip}"
set_node_environment "cluster_ip" "${cluster_ip}"

_hostname="${fqdn%%.*}"
_domain="${fqdn#*.}"

log_info "Setting hostname to ${_hostname} and domain to ${_domain}"
set_hostname
enable_init_service

sudo sed -E "s/[[:space:]]*\b${build_hostname}\b//g; s/[[:space:]]+/ /g" /etc/hosts
make_hosts_record "${public_ip}"  "${_hostname} ${_hostname}.${_domain}"
make_hosts_record "${cluster_ip}" "${_hostname}-cluster"

restart_shell

beep_done
