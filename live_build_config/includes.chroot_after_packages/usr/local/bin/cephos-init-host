#!/usr/bin/env bash

. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
CephOS Host Initialization Script

Options:
-n <fqdn>    Specify the Fully Qualified Domain Name (FQDN) for the host
             Format: hostname.domain.tld (e.g., ceph1.example.com)
-h           Display this help message
-v           Enable verbose output

Examples:
# Initialize host with FQDN
$0 -n ceph-first.domain.local

# Initialize host with FQDN and verbose output
$0 -n ceph-first.domain.local -v

EOF

set -euo pipefail

# --- options parse ---
fqdn=""
while getopts ":n:hv" opt
do
  case ${opt} in
    n) fqdn="${OPTARG}" ;;
    h) usage; exit 0 ;;
    v) verbose=1 ;;
   \?) wrong_opt "Error: unknown option -${OPTARG}" ;;
    :) wrong_opt "Error: option -${OPTARG} requires an argument" ;;
  esac
done

if [[ -z "$fqdn" ]]
then
  wrong_opt "Options not specified"
fi

if [[ "$fqdn" != *.* ]]
then
  log_cry "Error: string '${fqdn}' is not a FQDN (missing domain part)"
fi
# --- options parse ---
check_user "cephos"

_hostname="${fqdn%%.*}"
_domain="${fqdn#*.}"

function restart_shell()
{
  local current_shell
  current_shell=$(basename "${SHELL}")

  log_verbose "Reinitializing shell ${current_shell}"
  case "${current_shell}" in
    bash) exec bash ;;
    zsh)  exec zsh ;;
    *)    log_cry "Unknown shell: ${current_shell}. Only bash and zsh are supported. Relogin to update hostname" ;;
  esac
}

if [[ "$(hostname -s)" == "${build_hostname}" ]]
then
  log_info "Setting hostname to ${_hostname} and domain to ${_domain}"
  sudo sed -i "s/\b${build_hostname}\b/ ${_hostname} /g" "/etc/hosts"
  sudo domainname "${_domain}"
  sudo hostnamectl hostname "${_hostname}"
  restart_shell
else
  log_info "Already initialized"
fi
