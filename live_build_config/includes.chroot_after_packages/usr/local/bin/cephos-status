#!/usr/bin/env bash

. /usr/local/lib/cephos/base.sh.lib
. /usr/local/lib/cephos/config.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib
. /usr/local/lib/cephos/ceph.sh.lib
. /usr/local/lib/cephos/ssh.sh.lib

read -r -d '' help_text <<EOF
CephOS Cluster Status Script

Options:
-h  Display this help message
-v  Enable verbose output
EOF
set -euo pipefail
# --- functions ---
function clocks_skew()
{
  log_delimiter
  log_info "Cluster nodes clocks skew"
  ${sudo_ceph} ceph tell mon time-sync-status -f json | jq -r '
  .time_skew_status
  | to_entries[]
  | "\(.key)\n  latency: \(.value.latency)\n  skew: \(.value.skew)"
  '
}

function show()
{
  local title="$1"
  local cmd="$2"
  local as_verbose="$3"
  local run_on_all_nodes="$4"
  if (( (as_verbose && verbose) || !as_verbose ))
  then
    local no_empty_lines="grep -Ev '^[[:space:]]*$'"
    local fill_cmd="${sudo_ceph} ${cmd} | ${no_empty_lines}"

    log_delimiter
    log_info "${title} (${cmd})"
    eval "${fill_cmd}"
    if (( run_on_all_nodes ))
    then
      local user_home
      user_home="$(get_user_home "${build_user}")"
      generate_ssh_key "${user_home}" "${build_user}"
      mapfile -t ceph_hosts < <(get_ceph_hosts)
      for line in "${ceph_hosts[@]}"
      do
        read -r node_name public_ip cluster_ip <<< "${line}"
        if ! is_local_host "${node_name}"
        then
          spread_ssh_key "${user_home}" "${build_user}" "${public_ip}"
          exec_ssh "${public_ip}" "${build_user}" "${fill_cmd}"
        fi
      done
    fi
  fi
}

# --- functions ---
# --- options parse ---
while getopts ":hv" opt
do
  case ${opt} in
    h) usage     ;;
    v) verbose=1 ;;
   \?) wrong_opt "Unknown option -${OPTARG}"           ;;
    :) wrong_opt "Option -${OPTARG} requires argument" ;;
  esac
done
# --- options parse ---
# --- main ---
check_user "${build_user}"

show "Time synchronization sources"  "chronyc sources"             1 0
show "Time synchronization tracking" "chronyc tracking"            1 0
show "Time synchronization activity" "chronyc activity"            1 0

clocks_skew

show "Cluster health details"     "ceph health detail"             0 0
show "Ceph LVM volumes"           "ceph-volume lvm list"           1 1
show "Disk usage"                 "ceph df detail"                 0 0
show "OSD status"                 "ceph osd status"                0 0
show "OSD stats"                  "ceph osd stat"                  0 0
show "OSD utilization"            "ceph osd utilization"           0 0
show "OSD tree structure"         "ceph osd tree"                  0 0
show "OSD disk usage tree"        "ceph osd df tree"               0 0
show "OSD performance metrics"    "ceph osd perf"                  0 0
show "OSD auto scaling"           "ceph osd pool autoscale-status" 0 0
show "Pool statistics"            "ceph osd pool stats"            0 0
show "Placement Group statistics" "ceph pg stat"                   0 0
show "Placement Group summary"    "ceph pg dump summary"           0 0
show "Monitor statistics"         "ceph mon stat"                  0 0
show "CephFS filesystem status"   "ceph fs status"                 0 0
show "Cluster summary"            "ceph -s"                        0 0
