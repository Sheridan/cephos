#!/usr/bin/env bash

. /usr/local/lib/cephos/base.sh.lib
. /usr/local/lib/cephos/config.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
CephOS Cluster Status Script

Options:
-h  Display this help message
-v  Enable verbose output
EOF
set -euo pipefail

# --- options parse ---
while getopts ":hv" opt
do
  case ${opt} in
    h) usage; exit 0 ;;
    v) verbose=1 ;;
   \?) wrong_opt "Error: unknown option -${OPTARG}" ;;
    :) wrong_opt "Error: option -${OPTARG} requires argument" ;;
  esac
done
# --- options parse ---
# --- functions ---
function show()
{
  local title="$1"
  local cmd="$2"
  local as_verbose="$3"
  if (( (as_verbose && verbose) || !as_verbose ))
  then
    log_delimiter
    log_info "${title} ($cmd)"
    sudo $cmd
  fi
}
# --- functions ---
# --- main ---
check_user "cephos"

show "Timesync sources" "chronyc sources"   1
show "Timesync tracking" "chronyc tracking" 1
show "Timesync activity" "chronyc activity" 1

show "Health"         "ceph health detail"  0
show "Using"          "ceph df"             0
show "OSD tree"       "ceph osd tree"       0
show "OSD df tree"    "ceph osd df tree"    0
show "OSD perf"       "ceph osd perf"       0
show "Pools stats"    "ceph osd pool stats" 0
show "PG stats"       "ceph pg stat"        0
show "MON stats"      "ceph mon stat"       0
show "Cluster status" "ceph -s"             0
