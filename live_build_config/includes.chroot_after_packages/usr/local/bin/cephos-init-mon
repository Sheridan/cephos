#!/usr/bin/env bash

. /usr/local/lib/cephos/base.sh.lib
. /usr/local/lib/cephos/config.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
CephOS MON Initialization Script

Options:
-n  Cluster node when connecting to cluster
     If unset - generates new monmap
     Do not use manually (used internally from cephos-connect-to-cluster)
-h  Display this help message
-v  Enable verbose output
EOF
set -euo pipefail

# --- options parse ---
cluster_node=""
while getopts ":n:hv" opt
do
  case ${opt} in
    n) cluster_node="${OPTARG}" ;;
    h) usage     ;;
    v) verbose=1 ;;
   \?) wrong_opt "Unknown option -${OPTARG}"              ;;
    :) wrong_opt "Option -${OPTARG} requires an argument" ;;
  esac
done
# --- options parse ---
# --- main ---
check_user "${build_user}"

log_info "Initializing MON ${mon_id} with [fsid:${ceph_fsid}] and main configuration file ${ceph_main_conf}"

# --- Check & create MON if not exists ---
if ! sudo test -d "${mon_data_dir}"
then
  log_info "MON not found on this host, creating new MON"
  if [[ -z "${cluster_node}" ]]
  then
    log_verbose "Creating keys for mon"
    ${sudo_ceph} ceph-authtool --create-keyring ${ceph_conf_dir}/ceph.mon.keyring --gen-key -n mon. --cap mon 'allow *'
    ${sudo_ceph} ceph-authtool ${ceph_conf_dir}/ceph.mon.keyring --import-keyring ${ceph_conf_dir}/ceph.client.admin.keyring
    ${sudo_ceph} ceph-authtool ${ceph_conf_dir}/ceph.mon.keyring --import-keyring ${ceph_data_dir}/bootstrap-osd/ceph.keyring
    log_info "Preparing map for ${mon_id}"
    ${sudo_ceph} monmaptool --create --add ${mon_id} ${public_ip} --fsid ${ceph_fsid} ${ceph_data_dir}/bootstrap-mon/monmap --enable-all-features
  else
    log_info "Taking key from ${cluster_node} for ${mon_id}"
    ${sudo_ceph} ceph auth get mon. -o ${ceph_conf_dir}/ceph.mon.keyring
    log_info "Taking map from ${cluster_node} for ${mon_id}"
    ${sudo_ceph} ceph mon getmap -o "${ceph_data_dir}/bootstrap-mon/monmap"
  fi
  set_fs_permissions

  log_info "Creating directories ${mon_data_dir}"
  sudo mkdir -p "${mon_data_dir}"
  set_fs_permissions

  log_info "Creating mon instance ${mon_id}"
  ${sudo_ceph} ceph-mon \
    --mkfs \
    -i "${mon_id}" \
    --monmap "${ceph_data_dir}/bootstrap-mon/monmap" \
    --keyring "${ceph_conf_dir}/ceph.mon.keyring" \
    --conf "${ceph_main_conf}"
  set_fs_permissions

  manage_systemd_service_state "enable" "ceph-mon@${mon_id}"

  beep_done
else
  log_verbose "MON already exists on this host"
fi
