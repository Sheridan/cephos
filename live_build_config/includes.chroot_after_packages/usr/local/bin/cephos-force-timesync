#!/usr/bin/env bash

. /usr/local/lib/cephos/systemd.sh.lib

read -r -d '' help_text <<EOF
CephOS forced time sync

Options:
  -s <host>  Specify the time server host
  -h         Display this help message
  -v         Enable verbose output

Examples:
$0 -s time.domain.local -v
EOF
set -euo pipefail

# --- options parse ---
time_server=""
while getopts ":s:hv" opt
do
  case ${opt} in
    s) time_server="${OPTARG}" ;;
    h) usage     ;;
    v) verbose=1 ;;
   \?) wrong_opt "Unknown option -${OPTARG}"             ;;
    :) wrong_opt "Option -${OPTARG} requires an argument" ;;
  esac
done

if [[ -z "$time_server" ]]
then
  wrong_opt "Time server not specified"
fi
# --- options parse ---
# --- main ---
check_user "${build_user}"

ask_confirmation "This operation may cause some unpredictable consequences if the time is highly desynchronized. Continue?"

manage_systemd_service_state "stop" "chrony"
sudo chronyd -q "server ${time_server} iburst"
manage_systemd_service_state "start" "chrony"

beep_done
