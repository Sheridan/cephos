#!/usr/bin/env bash

log_cry "Не закончено"

. /usr/local/lib/cephos/cephos.sh.lib
. /usr/local/lib/cephos/blockdev.sh.lib

read -r -d '' help_text <<EOF
Usage: $0 -d <block_device>
Example: $0 -d /dev/sdb
EOF

set -euo pipefail
# --- options parse ---
block_device=""
while getopts ":d:hv" opt
do
  case ${opt} in
    d) block_device="${OPTARG}" ;;
    h) help; exit 0 ;;
    v) verbose=1 ;;
   \?) wrong_opt "Ошибка: неизвестная опция -${OPTARG}" ;;
    :) wrong_opt "Ошибка: опция -${OPTARG} требует аргумент" ;;
  esac
done

if [[ -z "$block_device" ]]
then
  wrong_opt "Не указаны опции"
fi

if [ ! -b "$block_device" ]
then
  log_cry "Block device ${block_device} not exists or not a valid block device"
fi
# --- options parse ---
check_user "cephos"
ask_confirmation "Эта операция уничтожит все данные на диске ${block_device}. Продолжать?"

function format_partitions()
{
  log_info "Форматирование..."
  sudo mkswap -L swap "${block_device}"
}

function update_fstab()
{
  local uuid_swap=$(sudo blkid -s UUID -o value "${block_device}")

  log_info "Добавляем записи в /etc/fstab..."
  echo "UUID=$uuid_swap none swap sw 0 0" | sudo tee -a /etc/fstab >/dev/null


}


function main()
{
  format_partitions
  update_fstab

  sudo swapon "${block_device}"
}

main
