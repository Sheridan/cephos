#!/usr/bin/env bash

. /usr/local/lib/cephos/blockdev.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
Script for make swap partition

Options:
  -d <block_device> Block device for swap
  -h                Display this help message
  -v                Enable verbose output
EOF
set -euo pipefail
# --- functions ---
function format_partitions()
{
  log_info "Creating swap on ${block_device}..."
  sudo mkswap -L swap "${block_device}"
}

function update_fstab()
{
  local uuid_swap
  uuid_swap=$(sudo blkid -s UUID -o value "${block_device}")

  log_info "Adding entries to /etc/fstab..."
  echo "UUID=${uuid_swap} none swap sw 0 0" | sudo tee -a /etc/fstab >/dev/null
}
# --- functions ---
# --- options parse ---
block_device=""
while getopts ":d:hv" opt
do
  case ${opt} in
    d) block_device="${OPTARG}" ;;
    h) usage     ;;
    v) verbose=1 ;;
   \?) wrong_opt "Unknown option -${OPTARG}"              ;;
    :) wrong_opt "Option -${OPTARG} requires an argument" ;;
  esac
done

if [[ -z "$block_device" ]]
then
  wrong_opt "Options not specified"
fi

if [[ ! -b "$block_device" ]]
then
  log_cry "Block device ${block_device} not exists or not a valid block device"
fi
# --- options parse ---
# --- main ---
check_user "${build_user}"
ask_confirmation "This operation will destroy all data on disk ${block_device}. Continue?"
format_partitions
update_fstab
sudo swapon "${block_device}"
sudo free -h
log_info "Done"
