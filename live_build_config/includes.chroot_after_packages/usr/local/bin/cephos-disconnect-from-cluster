#!/usr/bin/env bash

. /usr/local/lib/cephos/network.sh.lib
. /usr/local/lib/cephos/ssh.sh.lib
. /usr/local/lib/cephos/systemd.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
CephOS cluster disconnection script

Options:
-h: Display this help message
-v: Enable verbose output
EOF
set -euo pipefail
# --- functions ---
function force_flag()
{
  if (( force ))
  then
    echo "-f"
  else
    echo " "
  fi
}
# --- functions ---
# --- options parse ---
force=0
mon_id="$(get_mon_id)"
mgr_id="$(get_mgr_id)"
while getopts ":fhv" opt
do
  case ${opt} in
    f) force=1   ;;
    h) usage     ;;
    v) verbose=1 ;;
   \?) wrong_opt "Unknown option -${OPTARG}"              ;;
    :) wrong_opt "Option -${OPTARG} requires an argument" ;;
  esac
done
# --- options parse ---

# --- main ---
check_user "${build_user}"
ask_confirmation "This operation will remove all local disks from the cluster and destroy all data on disks. Finally, it will remove this node from the cluster. Continue?"

while read -r block_device
do
  echo "y" | cephos-disk-remove $(verbose_flag) -d "${block_device}" $(force_flag)
done < <(get_local_osd_disks)

manage_systemd_service_state "disable" "cephos-mds-manager"

log_info "Removing mgr '${mgr_id}'"
manage_systemd_service_state "disable" "ceph-mgr@${mgr_id}"
${sudo_ceph} ceph mgr fail "$mgr_id" || true

log_info "Removing mon '${mon_id}'"
manage_systemd_service_state "disable" "ceph-mon@${mon_id}"
${sudo_ceph} ceph mon remove "$mon_id" || true

log_info "Stopping and disabling any Ceph services"
sudo systemctl stop 'ceph-*.service' || true
sudo systemctl disable 'ceph-*.service' || true

log_info "Removing any Ceph data"
sudo rm -rf ${ceph_conf_dir}/*
sudo rm -rf ${ceph_data_dir}/*
sudo rm -rf ${cephos_data_dir}/*

log_info "Stopping and disabling any monitoring services"
manage_systemd_service_state "disable" "prometheus-node-exporter"
manage_systemd_service_state "disable" "telegraf"
manage_systemd_service_state "disable" "smartctl-exporter"
manage_systemd_service_state "disable" "ceph-exporter"

beep_done
