#!/usr/bin/env bash

. /usr/local/lib/cephos/base.sh.lib
. /usr/local/lib/cephos/config.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
Usage: $0 [-hv]
Initialize a Ceph Manager (MGR) node.

Options:
  -h  Show this help message and exit
  -v  Enable verbose mode
EOF
set -euo pipefail

# --- options parse ---
while getopts ":hv" opt
do
  case ${opt} in
    h) usage; exit 0 ;;
    v) verbose=1 ;;
   \?) wrong_opt "Error: unknown option -${OPTARG}" ;;
    :) wrong_opt "Error: option -${OPTARG} requires an argument" ;;
  esac
done
# --- options parse ---
# --- main ---
check_user "cephos"

log_info "Init mgr ${mgr_id} with [fsid:${ceph_fsid}] and main conf file ${ceph_main_conf}"

if ! sudo test -d "${mgr_data_dir}"
then
  log_info "MGR not found on this host, creating new MGR"

  log_info "Creating directories ${mgr_data_dir}"
  sudo mkdir -p "${mgr_data_dir}"

  log_info "Creating keys"
  ${sudo_ceph} ceph auth get-or-create mgr.${mgr_id} mon 'allow profile mgr' osd 'allow *' mds 'allow *' -o ${mgr_data_dir}/keyring

  set_fs_permissions

  manage_service_state "enable" "ceph-mgr@${mgr_id}"
  sleep 5

  log_info "Configuration"
  ${sudo_ceph} ceph mgr module enable dashboard
  ${sudo_ceph} ceph mgr module enable stats
  ${sudo_ceph} ceph config set mgr mgr/dashboard/server_port 8080
  ${sudo_ceph} ceph config set mgr mgr/dashboard/ssl false
  ${sudo_ceph} ceph config set mon mon_warn_on_insecure_global_id_reclaim_allowed false
  # ${sudo_ceph} ceph restful create-self-signed-cert

  if ! dashboard_user_exists "cephos"
  then
    log_info "Creating user 'cephos' with password 'P@ssw0rd'"
    cephos-dashboard-user $(verbose_flag) -p 'P@ssw0rd'
  fi
else
  log_verbose "MGR already exists on this host"
fi
