#!/usr/bin/env bash

. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
Usage: $0
Example: $0
EOF

set -euo pipefail

# --- options parse ---
while getopts ":hv" opt
do
  case ${opt} in
    h) help; exit 0 ;;
    v) verbose=1 ;;
   \?) wrong_opt "Ошибка: неизвестная опция -${OPTARG}" ;;
    :) wrong_opt "Ошибка: опция -${OPTARG} требует аргумент" ;;
  esac
done
# --- options parse ---

log_info "Init mgr ${mgr_id} with [fsid:${ceph_fsid}] and main conf file ${ceph_main_conf}"

# --- Check & create MON if not exists ---
if ! sudo test -d "${mgr_data_dir}"
then
  log_info "MGR not found on this host, creating new MGR"

  log_info "Создание каталогов ${mgr_data_dir}"
  sudo mkdir -p "${mgr_data_dir}"

  log_info "Создание ключей"
  sudo ceph auth get-or-create mgr.${mgr_id} mon 'allow profile mgr' osd 'allow *' mds 'allow *' -o ${mgr_data_dir}/keyring

  set_file_rights

  log_info "Старт сервиса ceph-mgr@${mgr_id}"
  sudo systemctl enable --now ceph-mgr@${mgr_id}.service
  sleep 5

  log_info "Настройка"
  sudo ceph mgr module disable restful
  sudo ceph mgr module enable stats
  sudo ceph mgr module enable dashboard
  sudo ceph config set mgr mgr/dashboard/server_port 8080
  sudo ceph config set mgr mgr/dashboard/ssl false
  echo 'P@ssw0rd' > /tmp/pass
  sudo ceph dashboard ac-user-create cephos -i /tmp/pass administrator
  rm -f /tmp/pass

else
  log_verbose "MGR already exists on this host"
fi
