#!/usr/bin/env bash

. /usr/local/lib/cephos/base.sh.lib
. /usr/local/lib/cephos/config.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
CephOS CephFS Initialization Script

Options:
-h  Display this help message
-v  Enable verbose output
EOF
set -euo pipefail

# --- options parse ---
while getopts ":hv" opt
do
  case ${opt} in
    h) usage ;;
    v) verbose=1 ;;
   \?) wrong_opt "Error: unknown option -${OPTARG}" ;;
    :) wrong_opt "Error: option -${OPTARG} requires an argument" ;;
  esac
done
# --- options parse ---
# --- main ---
check_user "cephos"

log_info "Creating CephFS '${cephfs_name}' pools"
${sudo_ceph} ceph osd pool create ${cephfs_name}_metadata
${sudo_ceph} ceph osd pool set    ${cephfs_name}_metadata bulk false
${sudo_ceph} ceph osd pool create ${cephfs_name}_data
${sudo_ceph} ceph osd pool set    ${cephfs_name}_data     bulk true

log_info "Creating filesystem '${cephfs_name}'"
${sudo_ceph} ceph fs new ${cephfs_name} ${cephfs_name}_metadata ${cephfs_name}_data

log_info "Configuring filesystem '${cephfs_name}'"
${sudo_ceph} ceph fs set ${cephfs_name} max_mds 1
${sudo_ceph} ceph fs set ${cephfs_name} standby_count_wanted 1
${sudo_ceph} ceph fs set ${cephfs_name} allow_standby_replay true
${sudo_ceph} ceph fs set ${cephfs_name} refuse_standby_for_another_fs false

set_fs_permissions

cephos-init-mds $(verbose_flag)
