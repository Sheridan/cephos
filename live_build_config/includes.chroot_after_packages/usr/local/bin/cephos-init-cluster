#!/usr/bin/env bash

. /usr/local/lib/cephos/base.sh.lib
. /usr/local/lib/cephos/config.sh.lib
. /usr/local/lib/cephos/ceph.sh.lib
. /usr/local/lib/cephos/cephos.sh.lib

read -r -d '' help_text <<EOF
CephOS Cluster Initialization Script

Options:
-h  Display this help message
-v  Enable verbose output
EOF
set -euo pipefail

# --- options parse ---
while getopts ":hv" opt
do
  case ${opt} in
    h) usage     ;;
    v) verbose=1 ;;
   \?) wrong_opt "Unknown option -${OPTARG}"              ;;
    :) wrong_opt "Option -${OPTARG} requires an argument" ;;
  esac
done
# --- options parse ---
# --- main ---
check_user "${build_user}"

ceph_fsid=$(uuidgen)
set_cluster_environment "fsid" "${ceph_fsid}"

log_info "Initializing cluster with [fsid:${ceph_fsid}] and main configuration file ${ceph_main_conf}"
create_directories

log_verbose "Creating configuration ${ceph_main_conf}"

ceph_conf_add_to_list "mon_initial_members" "$(hostname -s)"
ceph_conf_add_to_list "mon_host"            "${public_ip}"

ceph_conf_set "global" "fsid"               "${ceph_fsid}"

ceph_conf_set "global" "cluster_network"    "${cluster_network}"
ceph_conf_set "global" "public_network"     "${public_network}"
ceph_conf_set "global" "ms_bind_ipv4"       "on"
ceph_conf_set "global" "ms_bind_ipv6"       "on"

ceph_conf_set "global" "osd_pool_default_size"              "3"
ceph_conf_set "global" "osd_pool_default_min_size"          "2"
ceph_conf_set "global" "osd_crush_chooseleaf_type"          "1"
ceph_conf_set "global" "osd_pool_default_pg_autoscale_mode" "on"

ceph_conf_set "mon" "mon_lease"                               "8"
ceph_conf_set "mon" "mon_osd_down_out_interval"               "$((60*30))"
ceph_conf_set "mon" "mon_memory_autotune"                     "true"

ceph_conf_set "global" "autotune_memory_target_ratio"          "0.6"
ceph_conf_set "osd" "osd_memory_target_autotune"               "true"
ceph_conf_set "osd" "osd_memory_cache_resize_interval"         "60"
ceph_conf_set "osd" "bluestore_cache_autotune"                 "true"
# ceph_conf_set "osd" "osd_memory_target"                        "2Gi"

ceph_conf_set "osd" "osd_deep_scrub_randomize_ratio"           "0.5"
ceph_conf_set "osd" "bluestore_block_db_create"                "true"
ceph_conf_set "osd" "bluestore_compression_mode"               "none"
ceph_conf_set "osd" "bluestore_fsck_on_mount_deep"             "false"
ceph_conf_set "osd" "bluestore_fsck_on_mount"                  "true"
ceph_conf_set "osd" "bluestore_fsck_quick_fix_on_mount"        "false"
ceph_conf_set "osd" "bluestore_prefer_deferred_size"           "0"
# ceph_conf_set "osd" "bluestore_rocksdb_options"                "compression=kNoCompression"
ceph_conf_set "osd" "bluestore_sync_send"                      "false"
ceph_conf_set "osd" "osd_backfill_scan_max"                    "256"
ceph_conf_set "osd" "osd_backfill_scan_min"                    "32"
ceph_conf_set "osd" "osd_check_max_object_name_len_on_startup" "true"
ceph_conf_set "osd" "osd_client_op_priority"                   "63"
ceph_conf_set "osd" "osd_fast_fail_on_corruption"              "true"
ceph_conf_set "osd" "osd_heartbeat_grace"                      "64"
ceph_conf_set "osd" "osd_heartbeat_interval"                   "8"
ceph_conf_set "osd" "osd_max_backfills"                        "2"
ceph_conf_set "osd" "osd_max_scrubs"                           "1"
ceph_conf_set "osd" "osd_recovery_max_active"                  "4"
ceph_conf_set "osd" "osd_recovery_op_priority"                 "15"
ceph_conf_set "osd" "osd_recovery_sleep_hdd"                   "0.1"
ceph_conf_set "osd" "osd_recovery_sleep_ssd"                   "0.02"
ceph_conf_set "osd" "osd_scrub_auto_repair_num_errors"         "8"
ceph_conf_set "osd" "osd_scrub_auto_repair"                    "true"
ceph_conf_set "osd" "osd_scrub_during_recovery"                "false"
ceph_conf_set "osd" "osd_scrub_sleep_hdd"                      "0.2"
ceph_conf_set "osd" "osd_scrub_sleep"                          "0.05"
ceph_conf_set "osd" "osd_use_stale_snap"                       "false"

ceph_conf_set "osd" "osd_op_complaint_time"                    "64"

ceph_conf_set "global" "auth_client_required"  "cephx"
ceph_conf_set "global" "auth_cluster_required" "cephx"
ceph_conf_set "global" "auth_service_required" "cephx"

log_verbose "Creating keys"
${sudo_ceph} ceph-authtool --create-keyring ${ceph_conf_dir}/ceph.client.admin.keyring --gen-key -n client.admin --cap mon 'allow *' --cap osd 'allow *' --cap mgr 'allow *' --cap mds 'allow *'
${sudo_ceph} ceph-authtool --create-keyring ${ceph_data_dir}/bootstrap-osd/ceph.keyring --gen-key -n client.bootstrap-osd --cap mon 'profile bootstrap-osd' --cap mgr 'allow r'

set_fs_permissions
ceph_crash_up

log_info "Basic initialization completed"
log_delimiter
cephos-init-mon $(verbose_flag)
log_delimiter
cephos-init-mgr $(verbose_flag)

beep_done
